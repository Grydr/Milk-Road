#!/usr/bin/perl -w
#
# Count the number of sellers for a given snapshot
# (Figure 5)
#
# This script has not been tested with the databases publicly
# released. Use at your own risk.
# 
use Date::Parse;
use Digest::MD5 qw(md5 md5_hex md5_base64);
use DBI;
use DBD::mysql;
use POSIX;

$host = "127.0.0.1";    # CHANGE ME
$database_root = "";    # CHANGE ME
$port = 3306;           # CHANGE ME 
$item_table = "item";
$user = "root";         # CHANGE ME 
$pw = "";               # CHANGE ME

@snapshot_list=qw(1328220000 1328310000 1328390000 1328480000 1328570000 1328650000 1328740000 1328920000 1329000000 1329080000 1329180000 1329260000 1329350000 1329430000 1329520000 1329610000 1329690000 1329780000 1329870000 1329950000 1330030000 1330120000 1330210000 1330300000 1330380000 1330470000 1330560000 1330640000 1330730000 1330820000 1330900000 1330990000 1331760000 1331850000 1331940000 1332020000 1332100000 1332190000 1332300000 1332370000 1332460000 1332540000 1332630000 1332710000 1332800000 1332880000 1332970000 1333050000 1333150000 1333230000 1333320000 1333410000 1333490000 1333570000 1333660000 1333750000 1333920000 1334620000 1334780000 1334870000 1334950000 1335050000 1335130000 1335300000 1335650000 1335740000 1335820000 1335990000 1336250000 1336340000 1336430000 1336510000 1336600000 1336690000 1336770000 1336860000 1336940000 1337030000 1337120000 1337210000 1337290000 1337390000 1337460000 1337550000 1337630000 1337730000 1337810000 1337890000 1337980000 1338500000 1338590000 1338670000 1338760000 1339080000 1339190000 1339280000 1339360000 1339450000 1339530000 1339630000 1339710000 1339790000 1339880000 1339970000 1340060000 1340140000 1340230000 1340310000 1340400000 1340490000 1340570000 1340660000 1340750000 1340850000 1340920000 1341000000 1341090000 1341180000 1341270000 1341350000 1341440000 1341520000 1341610000 1341700000 1341780000 1341870000 1341950000 1342040000 1342650000 1342730000 1342820000 1342910000 1343080000);

&main(); 

sub main {
        my $dbh;
        my $sth; 

        foreach $snapshot (@snapshot_list) { 
                $database=$database_root.$snapshot;
                $dbh = DBI->connect("DBI:mysql:database=$database;host=$host;port=$port", $user, $pw) or die "Cannot connect to MySQL server\n";
                $sth = $dbh->prepare("SELECT count(seller) from $item_table GROUP BY seller") 
                        or die "Couldn't prepare statement: " . $dbh->errstr;
                $sth->execute() 
                        or die "Couldn't execute statement: " . $sth->errstr;
                
                printf STDOUT "%d\t%d\n", $snapshot, $sth->rows();
                $sth->finish(); 
                $dbh->disconnect();
        }
        return(-1);
}
